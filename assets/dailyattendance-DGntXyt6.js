import{r as n,j as e}from"./react-vendor-CHLR6qIU.js";import{d as l}from"./vendor-BJwQ_dIz.js";import{u as ce}from"./useAuth-ESA4DVxh.js";import{u as le}from"./useAttendance-D-ZesFcA.js";import{p as oe}from"./data-4NwGnHUR.js";import{b as de,d as q,e as ie,c as me,u as ue}from"./firebase-A1TrhjMY.js";import{d as O}from"./firebaseConfig-DYwBm8hJ.js";const he=1*60*1e3,S=5,xe=()=>{const{user:r}=ce(),{storeAttendance:B,getEmployeeAttendance:P}=le(),h=n.useRef(null),[i,w]=n.useState(!1),[x,k]=n.useState(null),[m,Y]=n.useState(null),[K,f]=n.useState(null),[Q,V]=n.useState(l()),[j,W]=n.useState(""),[A,X]=n.useState(""),[M,Z]=n.useState([]),[I,ee]=n.useState(""),[v,H]=n.useState(1),[te,D]=n.useState(!1),[T,L]=n.useState(""),R=()=>{localStorage.removeItem("attendanceSession"),w(!1),k(null),f(null),Y(l())},E=async()=>{if(!(r!=null&&r.employeeid))return;const a=[...await P(r.employeeid)].sort((s,c)=>{var o,C,p,d;return l(((C=(o=c.createdAt)==null?void 0:o.toDate)==null?void 0:C.call(o))||c.createdAt).valueOf()-l(((d=(p=s.createdAt)==null?void 0:p.toDate)==null?void 0:d.call(p))||s.createdAt).valueOf()});Z(a)},_=async(t="—",a="manual")=>{const s=l(),c=s.format("YYYY-MM-DD"),o=s.format("HH:mm:ss"),d=[...await P(r.employeeid)].sort((u,F)=>{var y,J,b,z;return l(((J=(y=F.createdAt)==null?void 0:y.toDate)==null?void 0:J.call(y))||F.createdAt).valueOf()-l(((z=(b=u.createdAt)==null?void 0:b.toDate)==null?void 0:z.call(b))||u.createdAt).valueOf()}).find(u=>u.date===c);if(!d||!d.tracker||!d.id)return;const N=d.tracker.findIndex(u=>u.clockOut==="--:--:--");if(N===-1)return;const g=[...d.tracker];g[N].clockOut=o,g[N].reason=a==="auto"?t:"—",g[N].type=a;const re=q(O,"attendance",d.id);await ue(re,{tracker:g}),R(),await E()},se=async()=>{const t=l(),a=t.format("HH:mm:ss"),s=t.format("YYYY-MM-DD");if(!(r!=null&&r.employeeid))return alert("User not found.");if(!j||!A)return alert("Select project and shift.");if(i)confirm("You are already clocked in. Punch out?")&&await _("—","manual");else{const c={employeeId:r.employeeid,firstName:r.firstName,project:j,date:s,shift:A,tracker:[{clockIn:a,clockOut:"--:--:--",reason:"—",type:"manual"}],createdAt:new Date};await B(c),localStorage.setItem("attendanceSession",JSON.stringify({isClockedIn:!0,startTime:t.toISOString()})),k(t),w(!0),f(0),Y(null),await E()}};n.useEffect(()=>{const t=localStorage.getItem("attendanceSession");if(t){const{isClockedIn:a,startTime:s}=JSON.parse(t),c=l(s),o=l();o.diff(c,"hour")<24?(w(a),k(c),f(o.diff(c,"second"))):R()}},[]),n.useEffect(()=>{let t;return i&&x&&(t=setInterval(()=>{f(l().diff(x,"second"))},1e3)),()=>clearInterval(t)},[i,x]),n.useEffect(()=>{const t=setInterval(()=>V(l()),1e3);return()=>clearInterval(t)},[]),n.useEffect(()=>{E()},[r]),n.useEffect(()=>{const t=()=>{!i||m||(h.current&&clearTimeout(h.current),h.current=setTimeout(async()=>{f(null);const s=prompt("🕒 Inactivity detected. Please provide a reason:");s&&await _(s,"auto")},he))},a=["mousemove","mousedown","keydown","touchstart","scroll"];return a.forEach(s=>window.addEventListener(s,t)),t(),()=>{a.forEach(s=>window.removeEventListener(s,t)),h.current&&clearTimeout(h.current)}},[i,m]);const ae=t=>{if(t==null)return"--:--:--";const a=String(Math.floor(t/3600)).padStart(2,"0"),s=String(Math.floor(t%3600/60)).padStart(2,"0"),c=String(t%60).padStart(2,"0");return`${a}:${s}:${c}`},ne=async()=>{if(!T.trim())return alert("❗Enter a reason");try{const a=(await de(q(O,"users",r.uid))).data();await ie(me(O,"leaveApplications"),{employeeId:r.employeeid,name:r.firstName,reason:T,project:(a==null?void 0:a.project)||j||"unknown",date:new Date,status:"Pending"}),alert("✅ Leave application sent."),L(""),D(!1)}catch{alert("❌ Failed to send leave application.")}},G=I?M.filter(t=>t.date===I):M,U=Math.ceil(G.length/S),$=G.slice((v-1)*S,v*S);return e.jsxs("div",{className:"bg-gray-100 min-h-screen",children:[te&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-4 rounded shadow-md w-[90%] max-w-md",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Apply Leave"}),e.jsx("textarea",{rows:4,className:"w-full border p-2 rounded",placeholder:"Enter reason for leave...",value:T,onChange:t=>L(t.target.value)}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx("button",{onClick:()=>D(!1),className:"px-3 py-1 border rounded",children:"Cancel"}),e.jsx("button",{onClick:ne,className:"px-3 py-1 bg-blue-500 text-white rounded",children:"Submit"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-white rounded shadow-sm p-4",children:[e.jsxs("h2",{className:"text-blue-500 font-bold",children:["Hi ",(r==null?void 0:r.firstName)||"Guest","!"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Please check your attendance..."}),e.jsx("p",{className:"text-[45px] text-center font-bold text-orange-400",children:ae(K)}),e.jsx("button",{onClick:()=>D(!0),className:"mt-4 w-full border border-blue-500 text-blue-500 py-2 rounded hover:bg-blue-500 hover:text-white",children:"Apply Leave"})]}),e.jsxs("div",{className:"bg-white rounded shadow-sm p-4 md:col-span-2",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-700",children:"Attendance"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:A,onChange:t=>X(t.target.value),className:"border rounded px-3 py-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Shift"}),e.jsx("option",{value:"Shift-1",children:"Shift 1"}),e.jsx("option",{value:"General",children:"General"}),e.jsx("option",{value:"Shift-2",children:"Shift 2"})]}),e.jsxs("select",{value:j,onChange:t=>W(t.target.value),className:"border rounded px-3 py-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Project"}),oe.map(t=>e.jsx("option",{value:t.key,children:t.label},t.key))]})]})]}),e.jsxs("div",{className:"flex justify-between my-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400",children:"Start Time"}),e.jsx("p",{className:"text-lg",children:x?x.format("HH:mm:ss"):"--:--:--"}),e.jsx("p",{className:"text-sm text-gray-600",children:Q.format("dddd, DD MMMM YYYY")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400",children:"End Time"}),e.jsx("p",{className:"text-lg",children:m?m.format("HH:mm:ss"):"--:--:--"})]})]}),e.jsx("div",{className:"w-full",children:!i||!m?e.jsx("button",{onClick:se,className:"w-full border border-blue-500 text-blue-500 py-2 rounded hover:bg-blue-500 hover:text-white",children:i?"Punch Out":"Punch In"}):e.jsxs("p",{className:"text-center text-gray-500",children:["You clocked out at ",m.format("HH:mm:ss")]})})]})]}),e.jsxs("div",{className:"bg-white rounded shadow-sm mt-2 p-4",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("h5",{className:"text-gray-700 font-semibold",children:"Recent Attendance"}),e.jsx("input",{type:"date",value:I,onChange:t=>{ee(t.target.value),H(1)},className:"border px-3 py-1 text-sm rounded"})]}),e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"w-full text-left border",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:"S.No."}),e.jsx("th",{className:"p-2",children:"Project"}),e.jsx("th",{className:"p-2",children:"Date"}),e.jsx("th",{className:"p-2",children:"Shift"}),e.jsx("th",{className:"p-2",children:"Punch In"}),e.jsx("th",{className:"p-2",children:"Punch Out"}),e.jsx("th",{className:"p-2",children:"Reason"}),e.jsx("th",{className:"p-2",children:"Type"})]})}),e.jsx("tbody",{children:$.length>0?$.map((t,a)=>{const s=t.tracker[t.tracker.length-1];return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:(v-1)*S+a+1}),e.jsx("td",{className:"p-2",children:t.project}),e.jsx("td",{className:"p-2",children:t.date}),e.jsx("td",{className:"p-2",children:t.shift}),e.jsx("td",{className:"p-2",children:(s==null?void 0:s.clockIn)||"--:--:--"}),e.jsx("td",{className:"p-2",children:(s==null?void 0:s.clockOut)||"--:--:--"}),e.jsx("td",{className:"p-2",children:(s==null?void 0:s.clockOut)!=="--:--:--"&&(s==null?void 0:s.reason)||"—"}),e.jsx("td",{className:"p-2",children:(s==null?void 0:s.clockOut)!=="--:--:--"?(s==null?void 0:s.type)||"manual":"—"})]},a)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"p-2 text-center text-gray-500 italic",children:"No records found."})})})]})}),U>1&&e.jsx("div",{className:"flex justify-center mt-3 gap-2",children:Array.from({length:U},(t,a)=>e.jsx("button",{onClick:()=>H(a+1),className:`px-3 py-1 rounded border ${v===a+1?"bg-blue-500 text-white":"bg-white text-gray-700"}`,children:a+1},a))})]})]})};function be(){return e.jsx("div",{children:e.jsx(xe,{})})}export{be as default};
