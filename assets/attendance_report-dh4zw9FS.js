import{r as d,j as e}from"./react-vendor-CHLR6qIU.js";import{u as ne}from"./useAttendance-DffnUxjs.js";import{d as n,u as H,b as oe,c as ce,i as de,e as ie}from"./vendor-BJwQ_dIz.js";import{d as F}from"./firebaseConfig-CKbRA7LN.js";import{g as ue,c as q,e as xe,u as me,d as pe}from"./firebase-A1TrhjMY.js";n.extend(ce);n.extend(de);n.extend(ie);function ye(){const{getAllAttendance:B}=ne(),[z,L]=d.useState([]),[N,Q]=d.useState([]),[b,V]=d.useState(n().format("YYYY-MM-DD")),[k,W]=d.useState(""),[G,O]=d.useState(!1),[J,D]=d.useState(!1),[m,R]=d.useState(null),[i,g]=d.useState({employeeId:"",firstName:"",lastName:"",date:n().format("YYYY-MM-DD"),clockIn:"09:00",clockOut:"17:00",remarks:""}),[j,A]=d.useState({clockIn:"",clockOut:"",remarks:""}),[v,K]=d.useState("daily"),[o,U]=d.useState({present:0,absent:0,late:0,onTime:0,inProgress:0,total:0});d.useEffect(()=>{(async()=>{try{const a=(await ue(q(F,"employees"))).docs.map(l=>({id:l.id,...l.data()}));Q(a)}catch(r){console.error("Error fetching employees:",r)}})()},[]);const X=t=>{const r=new Map;return N.forEach(a=>{const l=`${a.employeeId}-${b}`;r.set(l,{id:"",employeeId:a.employeeId,firstName:a.firstName,lastName:a.lastName,date:b,shift:a.shift||"general",remarks:"",tracker:[],isManual:!1,isAdjusted:!1,firstClockIn:null,lastClockOut:null,totalHours:"--:--:--",status:"Absent",statusClass:"bg-red-100 text-red-800",present:"Absent",presentClass:"bg-red-100 text-red-800",autoPunchOut:!1})}),t.forEach(a=>{const l=`${a.employeeId}-${a.date}`,s=r.get(l)||{id:a.id,employeeId:a.employeeId,firstName:a.firstName,lastName:a.lastName,date:a.date,shift:a.shift||"general",remarks:a.remarks||"",tracker:[],isManual:a.isManual||!1,isAdjusted:a.isAdjusted||!1,firstClockIn:null,lastClockOut:null,totalHours:"--:--:--",status:"Absent",statusClass:"bg-red-100 text-red-800",present:"Absent",presentClass:"bg-red-100 text-red-800",autoPunchOut:!1};s.tracker=[...s.tracker,...a.tracker||[]],s.isManual=s.isManual||a.isManual,s.isAdjusted=s.isAdjusted||a.isAdjusted,s.remarks=s.remarks||a.remarks,r.set(l,s)}),Array.from(r.values())},Z=t=>{const r={present:0,absent:0,late:0,onTime:0,inProgress:0,total:N.length};return t.forEach(a=>{a.present==="Present"&&r.present++,a.present==="Absent"&&r.absent++,a.status==="Late"&&r.late++,a.status==="On Time"&&r.onTime++,a.present==="In Progress"&&r.inProgress++}),r},ee=t=>{const l=X(t).map(s=>{if(s.tracker.length>0){const h=s.tracker.sort((c,x)=>{const f=c.clockIn||c.clockOut||"00:00:00",S=x.clockIn||x.clockOut||"00:00:00";return f.localeCompare(S)});let u=null,p=null,y=0;h.forEach(c=>{if(c.clockIn&&!u&&(u=c.clockIn),c.clockOut&&(p=c.clockOut),c.clockIn&&c.clockOut){const x=n(`${s.date} ${c.clockIn}`),f=n(`${s.date} ${c.clockOut}`);x.isValid()&&f.isValid()&&(y+=f.diff(x))}});const M=n.duration(y),T=y>0?`${String(M.hours()).padStart(2,"0")}:${String(M.minutes()).padStart(2,"0")}:${String(M.seconds()).padStart(2,"0")}`:"--:--:--";let C="Absent",w="bg-red-100 text-red-800",I="Absent",P="bg-red-100 text-red-800";if(u){I=p?"Present":"In Progress",P=p?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800";const c={general:"09:00","shift-1":"06:00","shift-2":"14:00"},x=15,f=c[s.shift]||"09:00",S=n(`${s.date} ${u}`),Y=n(`${s.date} ${f}`);S.isAfter(Y.add(x,"minute"))?(C="Late",w="bg-red-100 text-red-800"):(C="On Time",w="bg-blue-100 text-blue-800")}let _=!1;if(u&&!p){const x={general:"17:00","shift-1":"14:00","shift-2":"22:00"}[s.shift]||"17:00",f=n(),S=n(`${s.date} ${x}`);if(f.isAfter(S)){p=x,_=!0;const Y=n(`${s.date} ${p}`),le=n(`${s.date} ${u}`);y=Y.diff(le),I="Present",P="bg-green-100 text-green-800"}}return{...s,firstClockIn:u,lastClockOut:p,totalHours:T,status:C,statusClass:w,present:I,presentClass:P,autoPunchOut:_,tracker:h}}return s}).filter(s=>s.date===b);return U(Z(l)),l},E=async()=>{try{const t=await B(),r=ee(t);L(r)}catch(t){console.error("Failed to fetch attendance data:",t)}};d.useEffect(()=>{E()},[b,v,N]);const $=z.filter(t=>{var a,l,s;return k?((a=t.employeeId)==null?void 0:a.toLowerCase().includes(k.toLowerCase()))||((l=t.firstName)==null?void 0:l.toLowerCase().includes(k.toLowerCase()))||((s=t.lastName)==null?void 0:s.toLowerCase().includes(k.toLowerCase())):!0}),te=()=>{if($.length===0){alert("No data found for selected date!");return}const t=$.map(s=>({Date:s.date,EmployeeID:s.employeeId,"First Name":s.firstName,"Last Name":s.lastName,Shift:s.shift,Status:s.status,"Clock In":s.firstClockIn||"--:--:--","Clock Out":s.lastClockOut||"--:--:--","Total Hours":s.totalHours,Attendance:s.present,Remarks:s.remarks||"","Auto PunchOut":s.autoPunchOut?"Yes":"No",Adjusted:s.isAdjusted?"Yes":"No",Manual:s.isManual?"Yes":"No"})),r=H.json_to_sheet(t),a=H.book_new();H.book_append_sheet(a,r,"Attendance");const l=`Attendance_${v}_${b||"All"}_${n().format("YYYY-MM-DD_HH-mm")}.xlsx`;oe(a,l)},se=async()=>{try{const{employeeId:t,firstName:r,lastName:a,date:l,clockIn:s,clockOut:h,remarks:u}=i;if(!t||!r||!l||!s||!h)return alert("All fields are required!");const p=await xe(q(F,"attendance"),{employeeId:t,firstName:r,lastName:a,date:l,shift:"manual",tracker:[{clockIn:s,clockOut:h}],remarks:u,isManual:!0,adjustedBy:"admin",adjustedAt:new Date().toISOString()}),y=n(`2000-01-01T${s}`),T=n(`2000-01-01T${h}`).diff(y),C=n.duration(T).format("HH:mm:ss"),w={id:p.id,employeeId:t,firstName:r,lastName:a,date:l,shift:"manual",remarks:u,tracker:[{clockIn:s,clockOut:h}],isManual:!0,isAdjusted:!1,firstClockIn:s,lastClockOut:h,totalHours:C,status:"Manual Entry",statusClass:"bg-purple-100 text-purple-800",present:"Present",presentClass:"bg-green-100 text-green-800",autoPunchOut:!1};L(I=>[...I,w]),alert("Manual record added successfully!"),O(!1),g({employeeId:"",firstName:"",lastName:"",date:n().format("YYYY-MM-DD"),clockIn:"09:00",clockOut:"17:00",remarks:""}),E()}catch(t){console.error("Error saving manual entry:",t),alert("Failed to save manual entry. Please try again.")}},ae=async()=>{try{if(!m)return;const{clockIn:t,clockOut:r,remarks:a}=j;if(!t&&!r)return alert("At least one time adjustment is required!");await me(pe(F,"attendance",m.id),{tracker:[{clockIn:t||m.firstClockIn,clockOut:r||m.lastClockOut}],remarks:a||m.remarks,isAdjusted:!0,adjustedBy:"admin",adjustedAt:new Date().toISOString()}),alert("Attendance record updated successfully!"),D(!1),R(null),E()}catch(t){console.error("Error adjusting attendance:",t),alert("Failed to update attendance record. Please try again.")}},re=t=>{const r=t.target.value,a=N.find(l=>l.employeeId===r);g(l=>({...l,employeeId:r,firstName:(a==null?void 0:a.firstName)||"",lastName:(a==null?void 0:a.lastName)||""}))};return e.jsxs("div",{className:"container-fluid bg-gray-100 px-0 relative z-10",children:[e.jsxs("div",{className:"bg-white p-3 rounded",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200",children:[e.jsx("h3",{className:"text-sm font-medium text-green-800",children:"Present"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:o.present}),e.jsxs("p",{className:"text-xs text-green-600",children:[Math.round(o.present/o.total*100),"% of total"]})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg border border-red-200",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Absent"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:o.absent}),e.jsxs("p",{className:"text-xs text-red-600",children:[Math.round(o.absent/o.total*100),"% of total"]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h3",{className:"text-sm font-medium text-blue-800",children:"On Time"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:o.onTime}),e.jsxs("p",{className:"text-xs text-blue-600",children:[o.present>0?Math.round(o.onTime/o.present*100):0,"% of present"]})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200",children:[e.jsx("h3",{className:"text-sm font-medium text-yellow-800",children:"Late"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:o.late}),e.jsxs("p",{className:"text-xs text-yellow-600",children:[o.present>0?Math.round(o.late/o.present*100):0,"% of present"]})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border border-purple-200",children:[e.jsx("h3",{className:"text-sm font-medium text-purple-800",children:"In Progress"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:o.inProgress}),e.jsxs("p",{className:"text-xs text-purple-600",children:[o.present>0?Math.round(o.inProgress/o.present*100):0,"% of present"]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h1",{className:"text-xl font-semibold",children:[v==="daily"?"Daily":v==="weekly"?"Weekly":"Monthly","Attendance Report - ",n(b).format("DD MMM YYYY")]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:v,onChange:t=>K(t.target.value),className:"border px-3 py-1 rounded text-sm",children:[e.jsx("option",{value:"daily",children:"Daily"}),e.jsx("option",{value:"weekly",children:"Weekly"}),e.jsx("option",{value:"monthly",children:"Monthly"})]}),e.jsx("input",{type:"date",value:b,onChange:t=>V(t.target.value),className:"border px-3 py-1 rounded text-sm"}),e.jsx("input",{type:"text",placeholder:"Search by name or ID...",value:k,onChange:t=>W(t.target.value),className:"border px-3 py-1 rounded text-sm"}),e.jsx("button",{onClick:te,className:"bg-green-500 text-white text-sm px-3 py-1 rounded hover:bg-green-600",children:"Export Excel"}),e.jsx("button",{onClick:()=>O(!0),className:"bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600",children:"Manual Entry"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full table-auto text-sm border border-collapse",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-3 py-2 text-left",children:"Date"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Emp ID"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Employee Name"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Shift"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Punch In"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Punch Out"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Total Hours"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Status"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Attendance"}),e.jsx("th",{className:"border px-3 py-2 text-left",children:"Actions"})]})}),e.jsx("tbody",{children:$.map((t,r)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border px-3 py-2",children:n(t.date).format("DD-MM-YYYY")}),e.jsx("td",{className:"border px-3 py-2",children:t.employeeId}),e.jsxs("td",{className:"border px-3 py-2",children:[t.firstName," ",t.lastName]}),e.jsx("td",{className:"border px-3 py-2 capitalize",children:t.shift}),e.jsxs("td",{className:"border px-3 py-2",children:[t.firstClockIn||"--:--:--",t.isManual&&e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"(M)"})]}),e.jsxs("td",{className:"border px-3 py-2",children:[t.lastClockOut||"--:--:--",t.autoPunchOut&&e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"(A)"})]}),e.jsx("td",{className:"border px-3 py-2",children:t.totalHours}),e.jsx("td",{className:"border px-3 py-2",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${t.statusClass}`,children:t.status})}),e.jsx("td",{className:"border px-3 py-2",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${t.presentClass}`,children:t.present})}),e.jsx("td",{className:"border px-3 py-2",children:e.jsx("button",{onClick:()=>{R(t),A({clockIn:t.firstClockIn||"",clockOut:t.lastClockOut||"",remarks:t.remarks||""}),D(!0)},className:"text-blue-500 hover:text-blue-700 text-sm",children:"Adjust"})})]},`${t.employeeId}-${t.date}-${r}`))})]})})]}),G&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000]",children:e.jsxs("div",{className:"bg-white p-5 rounded shadow-md w-96",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"Manual Time Entry"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsxs("select",{value:i.employeeId,onChange:re,className:"border w-full p-2 rounded",required:!0,children:[e.jsx("option",{value:"",children:"Select Employee"}),N.map(t=>e.jsxs("option",{value:t.employeeId,children:[t.firstName," ",t.lastName," (",t.employeeId,")"]},t.id))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Date"}),e.jsx("input",{type:"date",value:i.date,onChange:t=>g({...i,date:t.target.value}),className:"border w-full p-2 rounded",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Clock In"}),e.jsx("input",{type:"time",value:i.clockIn,onChange:t=>g({...i,clockIn:t.target.value}),className:"border w-full p-2 rounded",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Clock Out"}),e.jsx("input",{type:"time",value:i.clockOut,onChange:t=>g({...i,clockOut:t.target.value}),className:"border w-full p-2 rounded",required:!0})]})]}),e.jsx("textarea",{placeholder:"Remarks (optional)",value:i.remarks,onChange:t=>g({...i,remarks:t.target.value}),className:"border w-full p-2 mb-3 rounded",rows:3}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:se,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"Save"}),e.jsx("button",{onClick:()=>O(!1),className:"bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500",children:"Cancel"})]})]})}),J&&m&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000]",children:e.jsxs("div",{className:"bg-white p-5 rounded shadow-md w-96",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"Adjust Attendance Record"}),e.jsxs("p",{className:"text-sm mb-4",children:["Editing record for ",e.jsxs("strong",{children:[m.firstName," ",m.lastName]})," (",m.date,")"]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Clock In"}),e.jsx("input",{type:"time",value:j.clockIn,onChange:t=>A({...j,clockIn:t.target.value}),className:"border w-full p-2 rounded"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Clock Out"}),e.jsx("input",{type:"time",value:j.clockOut,onChange:t=>A({...j,clockOut:t.target.value}),className:"border w-full p-2 rounded"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Remarks"}),e.jsxs("select",{value:j.remarks,onChange:t=>A({...j,remarks:t.target.value}),className:"border w-full p-2 rounded",children:[e.jsx("option",{value:"",children:"Select reason..."}),e.jsx("option",{value:"Forgot to punch",children:"Forgot to punch"}),e.jsx("option",{value:"Half day",children:"Half day"}),e.jsx("option",{value:"On leave",children:"On leave"}),e.jsx("option",{value:"System error",children:"System error"}),e.jsx("option",{value:"Manual adjustment",children:"Manual adjustment"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:ae,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"Save Changes"}),e.jsx("button",{onClick:()=>D(!1),className:"bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500",children:"Cancel"})]})]})})]})}export{ye as default};
